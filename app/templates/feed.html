{% extends "base.html" %}
{% block content %}
<h2>B√†i vi·∫øt m·ªõi</h2>

{% macro render_comment(comment, post) %}
<div class="comment" id="comment-{{ comment.id }}">
    <div class="comment-header">
        <img src="{{ url_for('static', filename='avatars/' + (comment.user.avatar or 'default.jpg')) }}" 
             class="comment-avatar" alt="{{ comment.user.username }}">
        <a href="{{ url_for('main.user_profile', user_id=comment.user.id) }}" class="comment-username">
            {{ comment.user.username }}
        </a>
        <span class="comment-time">
            {{ comment.created_at.strftime('%H:%M %d/%m') if comment.created_at else 'N/A' }}
        </span>
    </div>
    
    <div class="comment-content">
        {{ comment.content }}
    </div>
    
    <div class="comment-actions">
        <!-- Like b√¨nh lu·∫≠n -->
        <form method="POST" action="{{ url_for('main.like_comment', comment_id=comment.id) }}" class="like-comment-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn-like-comment {% if current_user in comment.liked_by %}liked{% endif %}">
                <span class="heart-icon">‚ù§Ô∏è</span>
                <span class="like-count">{{ comment.like_count() }}</span>
            </button>
        </form>
        
        <!-- N√∫t tr·∫£ l·ªùi -->
        <button class="btn-reply" data-comment-id="{{ comment.id }}">Tr·∫£ l·ªùi</button>
        
        <!-- N√∫t x√≥a (n·∫øu c√≥ quy·ªÅn) -->
        {% if comment.user_id == current_user.id or post.user_id == current_user.id %}
        <form method="POST" action="{{ url_for('main.delete_comment', comment_id=comment.id) }}" class="delete-comment-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn-delete-comment">X√≥a</button>
        </form>
        {% endif %}
    </div>
    
    <!-- Form tr·∫£ l·ªùi (·∫©n) -->
    <form method="POST" action="{{ url_for('main.reply_comment', comment_id=comment.id) }}" 
          class="reply-form" id="reply-form-{{ comment.id }}" style="display: none;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <textarea name="content" placeholder="Vi·∫øt ph·∫£n h·ªìi..." required></textarea>
        <button type="submit">G·ª≠i</button>
        <button type="button" class="btn-cancel-reply" data-comment-id="{{ comment.id }}">H·ªßy</button>
    </form>
    
    <!-- Danh s√°ch ph·∫£n h·ªìi -->
    <div class="replies" style="margin-left: 20px;">
        {% for reply in comment.replies|sort(attribute='created_at') %}
            {{ render_comment(reply, post) }}
        {% endfor %}
    </div>
</div>
{% endmacro %}

{% for post in posts %}
<div class="post" id="post-{{ post.id }}">
    <!-- Header b√†i vi·∫øt -->
    <div class="post-header">
        <img src="{{ url_for('static', filename='avatars/' + (post.user.avatar or 'default.jpg')) }}" 
             class="post-avatar" alt="{{ post.user.username }}">
        <a href="{{ url_for('main.user_profile', user_id=post.user.id) }}" class="post-username">
            {{ post.user.username }}
        </a>
        <span class="post-time">
            {{ post.created_at.strftime('%d/%m/%Y %H:%M') if post.created_at else 'N/A' }}
        </span>
    </div>
    
    <!-- N·ªôi dung b√†i vi·∫øt -->
    <div class="post-content">
        <p>{{ post.content }}</p>
    </div>

    <!-- ·∫¢nh b√†i vi·∫øt -->
    {% if post.image %}
        <img src="{{ url_for('static', filename='uploads/' + post.image) }}" class="post-image">
    {% endif %}

    <!-- Like b√†i vi·∫øt -->
    <div class="post-actions">
        <form method="POST" action="{{ url_for('main.like_post', post_id=post.id) }}" class="like-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn-like {% if current_user.is_authenticated and current_user in post.likes %}liked{% endif %}">
                <span class="heart-icon">‚ù§Ô∏è</span>
                <span class="like-count">{{ post.like_count() }}</span>
            </button>
        </form>
        <a href="{{ url_for('main.post_detail', post_id=post.id) }}" class="btn btn-outline btn-sm">üí¨ B√¨nh lu·∫≠n</a>
    </div>

    <!-- Form b√¨nh lu·∫≠n ch√≠nh -->
    <form method="POST" action="{{ url_for('main.comment', post_id=post.id) }}" class="comment-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <textarea name="content" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." required></textarea>
        <button type="submit">G·ª≠i</button>
    </form>

    <!-- Danh s√°ch b√¨nh lu·∫≠n g·ªëc (kh√¥ng c√≥ parent_id) -->
    <div class="comments">
        {% for comment in post.comments|sort(attribute='created_at') if not comment.parent_id %}
            {{ render_comment(comment, post) }}
        {% endfor %}
    </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/comments.js') }}"></script>
{% endblock %}