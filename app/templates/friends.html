{% extends 'base.html' %}

{% block content %}
<h2>üë• Danh s√°ch b·∫°n b√®</h2>

{% if friends %}
  <ul class="list-group">
    {% for friend in friends %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <img src="{{ url_for('static', filename='avatars/' + (friend.avatar or 'default.jpg')) }}" width="40" height="40" style="border-radius:50%; object-fit: cover; margin-right: 10px;">
          <span>{{ friend.username }}</span>
        </div>
        <div>
          <a href="{{ url_for('main.chat', friend_id=friend.id) }}" class="btn btn-outline-success btn-sm me-2">
            Nh·∫Øn tin v·ªõi {{ friend.username }}
          </a>
          <button class="btn btn-outline-primary btn-sm btn-call" data-friend-id="{{ friend.id }}" data-friend-username="{{ friend.username }}">
            G·ªçi tho·∫°i
          </button>
        </div>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>B·∫°n ch∆∞a c√≥ ng∆∞·ªùi b·∫°n n√†o.</p>
{% endif %}

<!-- Modal g·ªçi tho·∫°i -->
<div id="callModal" class="modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <h5>G·ªçi tho·∫°i v·ªõi <span id="callFriendName"></span></h5>
      <div class="mb-3">
        <button id="startCall" class="btn btn-primary">B·∫Øt ƒë·∫ßu g·ªçi</button>
        <button id="endCall" class="btn btn-danger" disabled>K·∫øt th√∫c g·ªçi</button>
      </div>
      <audio id="remoteAudio" autoplay></audio>
      <div id="callStatus" class="alert alert-info d-none"></div>
      <button id="closeCall" class="btn btn-secondary mt-3">ƒê√≥ng</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
<script>
  const socket = io();
  const currentUserId = {{ current_user_id }};
  let peerConnection = null;
  let callStartTime = null;
  let roomId = null;
  let friendId = null;
  let friendName = null;

  // UI elements
  const callModal = document.getElementById('callModal');
  const callFriendNameSpan = document.getElementById('callFriendName');
  const remoteAudio = document.getElementById('remoteAudio');
  const startCallBtn = document.getElementById('startCall');
  const endCallBtn = document.getElementById('endCall');
  const callStatus = document.getElementById('callStatus');
  const closeCallBtn = document.getElementById('closeCall');

  // Hi·ªÉn th·ªã tr·∫°ng th√°i cu·ªôc g·ªçi
  function updateStatus(message, type='info') {
    callStatus.textContent = message;
    callStatus.className = `alert alert-${type}`;
    callStatus.classList.remove('d-none');
  }

  // ·∫®n modal g·ªçi tho·∫°i
  function hideCallModal() {
    callModal.classList.remove('show');
    callModal.style.display = 'none';
    callModal.setAttribute('aria-hidden', 'true');
  }

  // Hi·ªán modal g·ªçi tho·∫°i
  function showCallModal() {
    callModal.style.display = 'flex';
    callModal.classList.add('show');
    callModal.setAttribute('aria-hidden', 'false');
  }

  // ƒê·∫∑t l·∫°i k·∫øt n·ªëi peer
  function resetPeerConnection() {
    if (peerConnection) {
      peerConnection.ontrack = null;
      peerConnection.onicecandidate = null;
      peerConnection.close();
      peerConnection = null;
    }
    remoteAudio.srcObject = null;
  }

  // Kh·ªüi t·∫°o k·∫øt n·ªëi peer
  function initPeerConnection() {
    resetPeerConnection();
    peerConnection = new RTCPeerConnection({
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });

    peerConnection.ontrack = event => {
      remoteAudio.srcObject = event.streams[0];
      updateStatus(`ƒê√£ k·∫øt n·ªëi √¢m thanh v·ªõi ${friendName}`);
    };

    peerConnection.onicecandidate = event => {
      if (event.candidate) {
        socket.emit('ice_candidate', {
          room_id: roomId,
          candidate: event.candidate,
          user_id: currentUserId,
          to_user: friendId
        });
      }
    };
  }

  // B·∫Øt ƒë·∫ßu g·ªçi
  startCallBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    try {
      initPeerConnection();
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      socket.emit('offer', {
        room_id: roomId,
        offer: offer,
        user_id: currentUserId,
        to_user: friendId
      });

      callStartTime = new Date();
      startCallBtn.disabled = true;
      endCallBtn.disabled = false;
      updateStatus(`ƒêang ch·ªù ${friendName} tham gia...`);
    } catch (err) {
      console.error(err);
      updateStatus('Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu cu·ªôc g·ªçi. Vui l√≤ng ki·ªÉm tra micro.', 'danger');
    }
  });

  // K·∫øt th√∫c g·ªçi
  endCallBtn.addEventListener('click', (e) => {
    e.preventDefault();
    const duration = callStartTime ? Math.round((new Date() - callStartTime) / 1000) : 0;
    socket.emit('leave_call', {
      room_id: roomId,
      user_id: currentUserId,
      friend_id: friendId,
      duration: duration
    });

    resetPeerConnection();
    startCallBtn.disabled = false;
    endCallBtn.disabled = true;
    updateStatus('Cu·ªôc g·ªçi ƒë√£ k·∫øt th√∫c.', 'info');
  });

  // ƒê√≥ng modal g·ªçi
  closeCallBtn.addEventListener('click', (e) => {
    e.preventDefault();
    if (!endCallBtn.disabled) {
      // N·∫øu cu·ªôc g·ªçi ƒëang di·ªÖn ra th√¨ k·∫øt th√∫c tr∆∞·ªõc
      endCallBtn.click();
    }
    hideCallModal();
    resetPeerConnection();
  });

  // Khi click n√∫t g·ªçi tho·∫°i tr√™n danh s√°ch b·∫°n b√®
  document.querySelectorAll('.btn-call').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();

      friendId = btn.getAttribute('data-friend-id');
      friendName = btn.getAttribute('data-friend-username');

      try {
        // L·∫•y th√¥ng tin call t·ª´ API
        const response = await fetch(`/call_info/${friendId}`);
        if (!response.ok) {
          const err = await response.json();
          alert(err.error || 'L·ªói khi l·∫•y th√¥ng tin g·ªçi.');
          return;
        }
        const data = await response.json();
        roomId = data.room_id;

        callFriendNameSpan.textContent = friendName;
        startCallBtn.disabled = false;
        endCallBtn.disabled = true;
        callStatus.classList.add('d-none');
        remoteAudio.srcObject = null;
        showCallModal();

        // Tham gia ph√≤ng g·ªçi
        socket.emit('join_call', { room_id: roomId, user_id: currentUserId });
      } catch (error) {
        console.error('L·ªói khi g·ªçi API call_info:', error);
        alert('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin cu·ªôc g·ªçi.');
      }
    });
  });

  // Socket events

  socket.on('user_joined', data => {
    if (data.user_id !== currentUserId) {
      updateStatus(`${friendName} ƒë√£ tham gia cu·ªôc g·ªçi.`);
    }
  });

  socket.on('offer', async data => {
    if (data.user_id !== currentUserId) {
      try {
        initPeerConnection();
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        socket.emit('answer', {
          room_id: roomId,
          answer: answer,
          user_id: currentUserId,
          to_user: data.user_id
        });

        callStartTime = new Date();
      } catch (err) {
        console.error('Error handling offer:', err);
        updateStatus('L·ªói khi nh·∫≠n l·ªùi m·ªùi g·ªçi.', 'danger');
      }
    }
  });

  socket.on('answer', async data => {
    if (data.user_id !== currentUserId && peerConnection) {
      try {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
      } catch (err) {
        console.error('Error setting remote answer:', err);
      }
    }
  });

  socket.on('ice_candidate', async data => {
    if (data.user_id !== currentUserId && peerConnection) {
      try {
        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
      } catch (err) {
        console.error('Error handling ICE candidate:', err);
      }
    }
  });

  socket.on('user_left', data => {
    if (data.user_id !== currentUserId) {
      resetPeerConnection();
      startCallBtn.disabled = false;
      endCallBtn.disabled = true;
      updateStatus(`${friendName} ƒë√£ r·ªùi kh·ªèi cu·ªôc g·ªçi.`, 'info');
    }
  });
</script>

<style>
/* Modal ki·ªÉu bootstrap-like */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1050;
}

.modal.show {
  display: flex;
}

.modal-dialog {
  background: #fff;
  border-radius: 6px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 5px 15px rgba(0,0,0,.5);
  padding: 1rem;
}
</style>
{% endblock %}
